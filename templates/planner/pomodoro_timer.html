{% extends 'base.html' %}

{% block title %}Pomodoro Timer - AI Study Planner{% endblock %}
{% block page_title %}Pomodoro Timer{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8" x-data="pomodoroTimer()">
        <!-- Timer Display -->
        <div class="text-center mb-8">
            <div class="inline-block bg-gradient-to-br from-purple-600 to-blue-600 rounded-full p-12 shadow-2xl">
                <div class="text-7xl font-bold text-white" x-text="displayTime"></div>
            </div>
        </div>

        <!-- Timer Controls -->
        <div class="flex justify-center space-x-4 mb-8">
            <button @click="startTimer" x-show="!isRunning" 
                    class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-semibold transition">
                Start
            </button>
            <button @click="pauseTimer" x-show="isRunning" 
                    class="bg-yellow-600 hover:bg-yellow-700 text-white px-8 py-3 rounded-lg font-semibold transition">
                Pause
            </button>
            <button @click="resetTimer" 
                    class="bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-lg font-semibold transition">
                Reset
            </button>
        </div>

        <!-- Preset Durations -->
        <div class="grid grid-cols-2 gap-4 mb-8">
            <button @click="setDuration(25)" 
                    class="p-4 border-2 rounded-lg hover:border-purple-600 transition"
                    :class="duration === 25 ? 'border-purple-600 bg-purple-50 dark:bg-purple-900' : 'border-gray-300'">
                <div class="text-2xl font-bold">25:00</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">Standard Pomodoro</div>
            </button>
            <button @click="setDuration(50)" 
                    class="p-4 border-2 rounded-lg hover:border-purple-600 transition"
                    :class="duration === 50 ? 'border-purple-600 bg-purple-50 dark:bg-purple-900' : 'border-gray-300'">
                <div class="text-2xl font-bold">50:00</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">Extended Session</div>
            </button>
        </div>

        <!-- Topic Selection -->
        <div class="mb-8">
            <label class="block text-sm font-medium mb-2">Study Topic (Optional)</label>
            <select x-model="selectedTopic" class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600">
                <option value="">No specific topic</option>
                {% for topic in topics %}
                <option value="{{ topic.id }}">{{ topic.subject.name }} - {{ topic.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Session Stats -->
        <div class="grid grid-cols-3 gap-4 p-6 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <div class="text-center">
                <div class="text-3xl font-bold text-purple-600" x-text="sessionsToday"></div>
                <div class="text-sm text-gray-600 dark:text-gray-400">Today</div>
            </div>
            <div class="text-center">
                <div class="text-3xl font-bold text-blue-600" x-text="sessionsWeek"></div>
                <div class="text-sm text-gray-600 dark:text-gray-400">This Week</div>
            </div>
            <div class="text-center">
                <div class="text-3xl font-bold text-green-600" x-text="totalSessions"></div>
                <div class="text-sm text-gray-600 dark:text-gray-400">Total</div>
            </div>
        </div>
    </div>
</div>

<script>
function pomodoroTimer() {
    return {
        duration: 25,
        timeLeft: 25 * 60,
        isRunning: false,
        interval: null,
        selectedTopic: '',
        sessionsToday: 0,
        sessionsWeek: 0,
        totalSessions: 0,
        
        get displayTime() {
            const minutes = Math.floor(this.timeLeft / 60);
            const seconds = this.timeLeft % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        },
        
        setDuration(minutes) {
            if (!this.isRunning) {
                this.duration = minutes;
                this.timeLeft = minutes * 60;
            }
        },
        
        startTimer() {
            this.isRunning = true;
            this.interval = setInterval(() => {
                if (this.timeLeft > 0) {
                    this.timeLeft--;
                } else {
                    this.completeSession();
                }
            }, 1000);
        },
        
        pauseTimer() {
            this.isRunning = false;
            clearInterval(this.interval);
        },
        
        resetTimer() {
            this.isRunning = false;
            clearInterval(this.interval);
            this.timeLeft = this.duration * 60;
        },
        
        async completeSession() {
            this.pauseTimer();
            
            // Log session to backend
            const formData = new FormData();
            formData.append('duration', this.duration);
            if (this.selectedTopic) {
                formData.append('topic_id', this.selectedTopic);
            }
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            try {
                const response = await fetch('{% url "planner:pomodoro_log" %}', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    this.sessionsToday++;
                    this.totalSessions++;
                    alert('ðŸŽ‰ Pomodoro completed! +10 XP');
                }
            } catch (error) {
                console.error('Error logging session:', error);
            }
            
            this.resetTimer();
        }
    }
}
</script>
{% endblock %}
